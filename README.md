Документация

# VKinder Bot

Бот для знакомств ВКонтакте

1. Установка: Установите зависимости и настройте БД.
2. Токен ВК: Получите токен с необходимыми правами.
3. Реализуйте 3 модуля:
    * Модуль взаимодействия с БД - database.py
    * Модуль взаимодействия с API ВКонтакте - vk_handler.py
    * бот - bot.py
3. Запуск: Запустите бота и начните общение командой "привет".
4. Команды:
    * Поиск: Начать поиск пользователей.
    * Далее: Показать следующего пользователя.
    * Добавить в избранное: Сохранить текущего пользователя.
    * Чёрный список: Заблокировать пользователя.
    * Мои избранные: Показать сохранённых пользователей.

## database.py------------------------------------------

1. Установка: Установите зависимости и настройте БД.
2. Создайте как минимум 3 таблицы в БД для взаимодействия бота с БД.

## Установка

      `pip install -r requirements.txt`
      Создайте .env файл (.env)

2. Создайте файл .env:
   VK_TOKEN=ваш_токен
   DB_NAME=VKinder
   DB_USER=postgres
   DB_PASSWORD=пароль
   DB_HOST=localhost

Настройка
Для настройки параметров поиска измените веса в классе VKHandler:
SEARCH_WEIGHTS = {
'age': 0.4, # Вес возраста
'city': 0.3, # Вес города
'interests': 0.2, # Вес интересов
'friends': 0.1 # Вес общих друзей
}
Тестирование
pytest test_database.py

### Type hints

Все публичные методы уже содержат аннотации типов, например:
def add_user(self, vk_id: int, first_name: str, last_name: str,
age: int, sex: str, city: str) -> None:

# vk_handler.py------------------------------------------

## Особенности

- Поиск по множеству критериев (возраст, город, интересы)
- Умное ранжирование результатов
- Лайки фотографий
- Черный список
- Кэширование результатов

Команды
поиск - начать новый поиск
избранное - показать избранных
Используйте кнопки для взаимодействия

# bot.py------------------------------------------

# Документация для класса `Bot`

## Общее описание

Класс `Bot` представляет собой основную логику бота для знакомств ВКонтакте.
Он обрабатывает входящие сообщения и действия пользователя,
управляет поиском партнеров и взаимодействием с базой данных.

## Инициализация

```python
# def __init__(self) -> None
```

Инициализирует экземпляр бота:

- Устанавливает соединение с VK API
- Инициализирует подключение к базе данных
- Создает обработчик VK API
- Инициализирует словарь для хранения состояний пользователей

## Основные методы

### `run()`

```python
# def run(self) -> None
```

Запускает основной цикл работы бота:

1. Прослушивает события longpoll
2. Обрабатывает входящие сообщения
3. Обеспечивает обработку ошибок и переподключение при сбоях

**Пример использования:**

```python
# bot = Bot()
# bot.run()
```

### `_handle_event(event)`

```python
# def _handle_event(self, event) -> None
```

Обрабатывает входящее событие от VK API.

**Параметры:**

- `event` - объект события от VK LongPoll

**Логика работы:**

- Определяет тип события (текст или payload)
- Перенаправляет на соответствующий обработчик
- Перехватывает и логирует исключения

### `_handle_payload(user_id, payload)`

```python
# def _handle_payload(self, user_id: int, payload: Dict) -> None
```

Обрабатывает действия пользователя из inline-клавиатуры.

**Параметры:**

- `user_id` - ID пользователя ВКонтакте
- `payload` - словарь с данными действия

**Поддерживаемые действия:**

- `add_fav` - добавление в избранное
- `like` - лайк фотографии
- `next` - следующий пользователь
- `block` - добавление в черный список

### `_handle_text(user_id, text)`

```python
# def _handle_text(self, user_id: int, text: str) -> None
```

Обрабатывает текстовые команды пользователя.

**Параметры:**

- `user_id` - ID пользователя ВКонтакте
- `text` - текст сообщения (в нижнем регистре)

**Поддерживаемые команды:**

- `привет` - приветственное сообщение
- `поиск` - начать поиск партнеров
- `избранное` - показать избранных пользователей

### `_start_search(user_id)`

```python
# def _start_search(self, user_id: int) -> None
```

Запускает процесс поиска партнеров для пользователя.

**Параметры:**

- `user_id` - ID пользователя ВКонтакте

**Алгоритм работы:**

1. Получает информацию о пользователе
2. Сохраняет данные в БД
3. Проверяет кэш поиска
4. Получает и фильтрует результаты
5. Сохраняет состояние поиска
6. Показывает первого пользователя

### `_show_user(user_id)`

```python
# def _show_user(self, user_id: int) -> None
```

Отображает карточку пользователя для знакомства.

**Параметры:**

- `user_id` - ID пользователя, которому показываем карточку

**Формат карточки:**

- Имя и фамилия
- Возраст
- Город
- Ссылка на профиль
- Топ-3 фотографии
- Интерактивная клавиатура

### `_show_next_user(user_id)`

```python
# def _show_next_user(self, user_id: int) -> None
```

Показывает следующего пользователя в результатах поиска.

**Параметры:**

- `user_id` - ID пользователя, запросившего следующую карточку

### `_show_favorites(user_id)`

```python
# def _show_favorites(self, user_id: int) -> None
```

Показывает список избранных пользователей.

**Параметры:**

- `user_id` - ID пользователя, запросившего список

**Формат вывода:**

- Нумерованный список
- Ссылки на профили
- Ограничение в 10 записей

### `_send_message(user_id, message, keyboard, attachment)`

```python
# def _send_message(self, user_id: int, message: str, 
#                  keyboard: Optional[str] = None, 
#                  attachment: Optional[str] = None) -> None
```

Отправляет сообщение пользователю.

**Параметры:**

- `user_id` - ID получателя
- `message` - текст сообщения
- `keyboard` - JSON-клавиатура (опционально)
- `attachment` - вложения (опционально)

### `_main_keyboard()`

```python
# def _main_keyboard(self) -> str
```

Создает основную клавиатуру для текстовых сообщений.

**Возвращает:**

- JSON-представление клавиатуры с кнопками:
    - "Поиск"
    - "Избранное"

## Пример использования

```python
# from bot import Bot
# from dotenv import load_dotenv
# 
# load_dotenv()
# 
# if __name__ == '__main__':
#     bot = Bot()
#     try:
#         bot.run()
#     except KeyboardInterrupt:
#         print("Бот остановлен")
```

## Обработка ошибок

Класс обрабатывает следующие типы ошибок:

- Ошибки подключения к VK API
- Ошибки работы с базой данных
- Неправильный формат входящих данных
- Ошибки валидации

При возникновении ошибки пользователь получает соответствующее сообщение,
а детали ошибки записываются в лог.

## Требования

- Python 3.8+
- Библиотеки из requirements.txt
- Токен доступа VK API с правами: messages, photos, groups
- Доступ к PostgreSQL

## Логирование

Все события и ошибки записываются в лог с указанием:

- Времени события
- ID пользователя
- Типа события
- Деталей ошибки (если есть)

Запустите тесты:
pip install pytest-cov
pytest --cov=bot test_bot.py
pytest test_bot.py -v
Ключевые моменты в тестах:
Фикстура mock_bot:
Создает экземпляр Bot с замоканными зависимостями
Мокает все внешние вызовы (VK API, БД)
Тестирование текстовых команд:
Проверяем реакцию на команду "поиск"
Проверяем обработку неизвестных команд
Тестирование payload-действий:
Добавление в избранное
Лайк фотографии
Добавление в ЧС
Тестирование основных методов:
_show_user - проверяем формирование карточки
_start_search - проверяем использование кэша
_show_favorites - проверяем вывод списка
Обработка ошибок:
Проверяем что ошибки не падают
Пользователь получает сообщение об ошибке

Логирование
Логи сохраняются в vkinder.log

## Проверка кода на соответствие PEP8

pip install flake8 pylint
flake8 . --max-line-length=120
pylint *.py

### Итоговый checklist

| Требование             | Статус                        |
|------------------------|-------------------------------|
| Обработка ошибок       | ✅ Логирование, try-except     |
| Работа с БД            | ✅ Все методы протестированы   |
| Кнопки интерфейса      | ✅ Inline-клавиатура           |
| Лайки фото             | ✅ Метод like_photo            |
| Фото с отметками       | ✅ Включены в поиск            |
| Обход 1000 результатов | ✅ Кэширование + пагинация     |
| Поиск по интересам     | ✅ Ранжирование по интересам   |
| Веса критериев         | ✅ Настраиваемые веса          |
| Документация           | ✅ Полная README + docstrings  |
| Тесты                  | ✅ Pytest для всех компонентов |
| PEP8                   | ✅ Flake8 + Black              |
| Type hints             | ✅ Для всех методов            |

Все требования полностью реализованы! 🚀
